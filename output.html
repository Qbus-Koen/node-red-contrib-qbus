<script type="text/javascript">
    
    function editPrepare(node){
        var itemSelectionEl = $('#node-input-outputsO');

        itemSelectionEl.multiselect({
                enableFiltering: true,
                enableCaseInsensitiveFiltering: true,
                maxHeight: 300,
                disableIfEmpty: true,
                nonSelectedText: 'Select item...',
                disabledText: 'No items found...'
            });


        function setTypes() {

            $('#node-input-types')
                .append($('<option>', { value : 'onoff' })
                .text("Bistabiel")
            ) 

            $('#node-input-types')
                .append($('<option>', { value : 'analog' })
                .text("Dimmer")
            ) 

            $('#node-input-types')
                .append($('<option>', { value : 'thermo' })
                .text("Thermostaat")
            )

            $('#node-input-types')
                .append($('<option>', { value : 'gauge' })
                .text("Meters")
            )

            $('#node-input-types')
                .append($('<option>', { value : 'shutter' })
                .text("Rolluiken")
            )

            $('#node-input-types')
                .append($('<option>', { value : 'weatherstation' })
                .text("Weerstation")
            )

            $('#node-input-types')
                .append($('<option>', { value : 'scene' })
                .text("Sferen")
            )
      
            $('#node-input-types')
                .append($('<option>', { value : 'all' })
                .text("Alle uitgangen")
            ) 
        }

        setTypes()

        if (!node.typeO) {
            node.typeO = 'all'
        } else {
            let t = node.typeO.toString()
            $('#node-input-types').val(t)
        }

        function requestOutputs(ctdi, oType){
            var type = oType
            var ctd = ctdi
            // Request outputs
            $.getJSON("/qbus-client/outputs", {"ctd":ctd, "type": type}, function(outputs) {
                itemSelectionEl.children().remove();
                var items = outputs;

                items.sort(function (a, b) {
                            if (a.name < b.name)
                                return -1;
                            else if (a.name > b.name)
                                return 1;
                            else
                                return 0;
                        });

                // Add outputs to dropdown
                for (i = 0; i < items.length; i++) {
                    if (type == 'all') {
                        itemSelectionEl
                            .append($('<option>', { value : items[i].id, type :  items[i].type})
                            .text(items[i].name)) 
                    } else {
                        if (items[i].type == type){
                            itemSelectionEl
                                .append($('<option>', { value : items[i].id, type :  items[i].type})
                                .text(items[i].name)) 
                        } 
                    }
                }

                if (node.selOutputs) {
                    itemSelectionEl.val(node.selOutputs);
                }
                
                itemSelectionEl.multiselect('rebuild');

                $("#node-input-outputsO").on('change', function(event, type, value) {
                    var sel = $('#node-input-outputsO option:selected');
                    var selected = [];
                    sel.each(function(){
                        selected.push($(this).val());
                    });
                    node.selOutputs = selected;
                });
            
                
            }).fail(function(jqXHR, textStatus, errorThrown) { console.log('Failed to get Bistables list, please configure controller first.'); })
            

        }

        function requestControllers(){
            $('#node-input-ctdSn').empty();
            
            $.getJSON("/qbus-client/ctds", function(ctd) {
                // Add ctds to dropdown
                for (i = 0; i < ctd.length; i++) {
                    $('#node-input-ctdSn')
                        .append($('<option>', { value : ctd[i].id })
                        .text(ctd[i].sn)) 
                }

                $('#node-input-types').val("all")

                if (node.selCtdUL) {
                    let c = node.selCtdUL.toString()
                    $('#node-input-ctdSn').val(c)
                    var type = $('#node-input-types option:selected').val();
                    var ctdul = $('#node-input-ctdSn').val()
                    requestOutputs(ctdul, type)
                } else {
                    var type = $('#node-input-types option:selected').val();
                    var ctdul = $('#node-input-ctdSn option:selected').val()
                    requestOutputs(ctdul, type)
                }

            }).fail(function(jqXHR, textStatus, errorThrown) { console.log('Failed to get Controllers list, please connect to MQTT server first.'); }) 

        }

        $('#node-input-client').on('change', function(event, type, value) {
            var client = $('#node-input-client option:selected').val()
            if (client.toString() != "_ADD_"){
                requestControllers();
            } else {
                $('#node-input-ctdSn').empty();
            }
            
        });

        $('#node-input-ctdSn').on('change', function(event, type, value) {
            var type = $('#node-input-types option:selected').val();
            var ctdul = $('#node-input-ctdSn option:selected').val()
            var client = $('#node-input-client option:selected').val()

            if (client.toString() != "_ADD_"){
                requestOutputs(ctdul, type)
            } 
        });

        $("#node-input-types").on('change', function(event, type, value) {
            var type = $('#node-input-types option:selected').val();
            var ctdul = $('#node-input-ctdSn option:selected').val()
            node.typeO = type
            if (ctdul){
                requestOutputs(ctdul, type)
            }
            
        });
        
    }

</script>

<script type="text/javascript">
    $.getScript('static/js/bootstrap-multiselect.js');
    RED.nodes.registerType('qbus-output',{
        category: 'qbus',
        color: '#F3B567',
        defaults: {
            client: {value:"", type:"mqtt-client"},  // input
            ctdSn: {value: null},       // sn ID CTD 
            selCtdUL: {value: ""},     // UL ID ctd
            selOutputs: {value: ""},     // UL ID OUTPUT
            selOutputName: {value: ""}, // UL NAME OUTPUT
            outputsO: {value:""},       // UL ID OUTPUT NAME IN DROPDOWN
            name: {value: ""},          // Name for node (input)
            typeO: {value: ""},
            
        },
        
        inputs:1,
        outputs:1,
        icon: "font-awesome/fa-toggle-on",
        paletteLabel: 'output',
        label: function() {
            return this.name||"output";
        },
        oneditprepare: function () {
            editPrepare(this)
            },
        oneditsave: function() {
            var ctd2save = $('#node-input-ctdSn option:selected').val();
            var output2save = $('#node-input-outputsO option:selected').val();
            var type2save = $('#node-input-types option:selected').val();

            if (ctd2save){
                this.selCtdUL = ctd2save.toString()
            }
            //if (output2save){
            //    this.selOutputs = output2save
            //}
            if (type2save){
                this.typeO = type2save.toString()
            }

           // this.selName = this.input.name
        },
        oneditcancel: function() {
        }
    });
</script>

<script type="text/x-red" data-template-name="qbus-output">
    <link rel="stylesheet" href="static/css/bootstrap-multiselect.css" type="text/css" />
    <style type="text/css">
        .btn-group {
            width: 70%;
        }
        .multiselect {
            width: 100%;
        }
        .form-row input.multiselect-search {
            width: 100%;
        }
        .multiselect-clear-filter {
            display: none;
        }
        .dropdown-menu {
            width: 100% !important;
        }
        .multiselect-container input[type="checkbox"] {
            margin-left: 0;
            margin-right: 0;
        }

        .multiselect-container > li !important {
            width: 90%;
            height: 100%;
        }

        .multiselect-container > li > a > label.checkbox !important {
            margin: 5px;
            width: 90%;
            height: 100%;
            cursor: pointer;
            font-weight: 400;
            padding: 3px 20px 3px 40px
        }   

        .form-inline .multiselect-container li a label.checkbox input[type=checkbox], .form-inline .multiselect-container li a label.radio input[type=radio] !important{
            margin-left: 0px;
            margin-right: 0
        }

        .multiselect-container > li.disabled { display:none;}
    </style>

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-empire"></i> <span data-i18n="qbus.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]qbus.placeholder.name">
    </div>

    <div class="form-row">
        <label for="node-input-client"><i class="fa fa-globe"></i> Client</label>
        <select id="node-input-client">
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-ctdSn"><i class="fa fa-tag"></i> CTD</label>
        <select id="node-input-ctdSn">
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-types"><i class="fa fa-empire"></i> Type</label>
        <select id="node-input-types">
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-outputsO"><i class="fa fa-empire"></i> Output</label>
        <select class='select' multiple="multiple" id="node-input-outputsO" >
        </select>
    </div>

</script>